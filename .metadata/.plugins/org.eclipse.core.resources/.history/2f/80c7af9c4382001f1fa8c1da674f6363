package com.ktdsuniversity.edu.hello_spring.web;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;

import com.ktdsuniversity.edu.hello_spring.service.ToDoListService;
import com.ktdsuniversity.edu.hello_spring.vo.ToDoListVO;
import com.ktdsuniversity.edu.hello_spring.vo.ToDoListWriteVO;
import com.ktdsuniversity.edu.hello_spring.vo.ToDoVO;

import org.springframework.web.bind.annotation.RequestParam;


@Controller
public class ToDoListController {
	
	@Autowired 
	private ToDoListService toDoListService;
	
	/**
	 * 
	 * @return
	 */
	@GetMapping("/todolist/writelist")
	public String renderToDoListForm() {
		return "todolist/todowritelist";
	}

	
	/**
	 * 사용자가 입력한 값을 서버에 전송하기 위한 컨트롤러.
	 * 
	 * @param toDoListWriteVO: 사용자가 입력한 값을 담은 VO 객체.
	 * @param model: 사용자가 필수 입력칸을 입력하지 않았을 때 원래 입력했던 값을 다시 보여주기 위해 보여줘야 한다.
	 */
	@PostMapping("/todolist/writelist")
	public String writeToDoList(ToDoListWriteVO toDoListWriteVO, Model model) {
		
		// 유효성 검사를 한다.
		if(toDoListWriteVO.getSubject() == null || toDoListWriteVO.getSubject()=="") {
			model.addAttribute("error_subject", "제목은 필수 입력값입니다.");
			model.addAttribute("toDoListWriteVO", toDoListWriteVO);
			return "todolist/todowritelist";
		}
		
		if(toDoListWriteVO.getDeadLine() == null || toDoListWriteVO.getDeadLine() =="") {
			model.addAttribute("error_subject", "완료일 입력은 필수 입력란입니다.");
			model.addAttribute("toDoListWriteVO", toDoListWriteVO);
			return "todolist/todowritelist";
		}

		boolean isCreated = toDoListService.insertNewToDoList(toDoListWriteVO);
		
		if(isCreated) {
			System.out.println("성공적으로 TODO LIST가 등록되었습니다.");
			return "redirect:/todolist/list";
		}
		else {
			throw new IllegalArgumentException("알 수 없는 시스템 오류로 TODO LIST 생성에 실패했습니다. 다시 시도해주세요.");
		}
		
	}
	
	/**
	 * 
	 * @param model
	 * @return
	 */
	@GetMapping("/todolist/list")
	public String getAllToDoList(Model model) {
		
		ToDoListVO toDoListVO = new ToDoListVO();
		toDoListVO = toDoListService.selectAllToDoList();
		
		if(toDoListVO == null) {
			throw new IllegalArgumentException("알 수 없는 시스템 오류로 TODO LIST 목록을 가져오는데 실패했습니다.");
		}
		
		System.out.println("Retrieved ToDo List: " + toDoListVO.getToDoList());
		
		model.addAttribute("toDoList", toDoListVO.getToDoList());
		
		return "todolist/todolist";
	}
	
	@GetMapping("/todolist/modify/{id}")
	public String getModifyIsFinished(@PathVariable int id) {
		return "/todolist/modify/{id}";
	}
	
	@PostMapping("/todolist/modify/{id}")
	public String postModifyIsFinished(@PathVariable int id) {
		
		boolean isModified = toDoListService.updateIsFinished(id);
		
		if(isModified) {
			return "redirect:/todolist/list";
		}
		System.out.println("수정 안됨.");
		return "redirect:/todolist/list";
	}
	
}
